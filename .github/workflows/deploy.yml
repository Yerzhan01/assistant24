name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  create:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set Environment Target
      id: target
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "ENV_NAME=dev" >> $GITHUB_ENV
          echo "DOMAIN=dev.link-it.tech" >> $GITHUB_ENV
          echo "COMPOSE_FILE=docker-compose.dev.yml" >> $GITHUB_ENV
          echo "Deploying to DEVELOPMENT environment"
        elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          echo "ENV_NAME=prod" >> $GITHUB_ENV
          echo "DOMAIN=link-it.tech" >> $GITHUB_ENV
          echo "COMPOSE_FILE=docker-compose.prod.yml" >> $GITHUB_ENV
          echo "Deploying to PRODUCTION environment"
        fi

    - name: Install SSH Key
      run: |
        mkdir -p ~/.ssh/
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        echo "StrictHostKeyChecking no" >> ~/.ssh/config

    - name: Deploy to Server
      env:
        HOST: ${{ secrets.HOST || '95.217.8.206' }}
        USER: root
        PROJECT_PATH: /app/${{ env.ENV_NAME }}
        INFRA_PATH: /app/infra
      run: |
        # Create directories
        ssh -i ~/.ssh/id_ed25519 $USER@$HOST "mkdir -p $PROJECT_PATH $INFRA_PATH"

        # Transfer project files
        rsync -avz -e "ssh -i ~/.ssh/id_ed25519" \
          --exclude '.git' --exclude 'venv' --exclude 'node_modules' --exclude '__pycache__' \
          ./ $USER@$HOST:$PROJECT_PATH/

        # Copy infra files to infra directory
        rsync -avz -e "ssh -i ~/.ssh/id_ed25519" \
          docker-compose.infra.yml init-db.sql \
          $USER@$HOST:$INFRA_PATH/

        # Deploy infrastructure (only if not running)
        ssh -i ~/.ssh/id_ed25519 $USER@$HOST "cd $INFRA_PATH && \
          docker network create assistant-net 2>/dev/null || true && \
          docker compose -f docker-compose.infra.yml up -d"

        # Deploy environment
        ssh -i ~/.ssh/id_ed25519 $USER@$HOST "cd $PROJECT_PATH && \
          export GEMINI_API_KEY='${{ secrets.GEMINI_API_KEY }}' && \
          if [ ! -f .env ]; then cp .env.example .env 2>/dev/null || touch .env; fi && \
          docker compose -f ${{ env.COMPOSE_FILE }} down --remove-orphans && \
          docker compose -f ${{ env.COMPOSE_FILE }} build --no-cache && \
          docker compose -f ${{ env.COMPOSE_FILE }} up -d"

    - name: Post Checkout code
      run: echo "Deployment to ${{ env.ENV_NAME }} completed"

    - name: Complete job
      run: echo "âœ… Deploy to ${{ env.DOMAIN }} finished"
