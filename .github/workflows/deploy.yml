name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  create:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set Environment Target
      id: target
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "ENV_NAME=prod" >> $GITHUB_ENV
          echo "DOMAIN=link-it.tech" >> $GITHUB_ENV
          echo "Deploying to PRODUCTION"
        fi

    - name: Install SSH Key
      run: |
        mkdir -p ~/.ssh/
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        echo "StrictHostKeyChecking no" >> ~/.ssh/config

    - name: Deploy to Server
      env:
        HOST: ${{ secrets.HOST || '95.217.8.206' }}
        USER: root
        PROJECT_PATH: /app/assistant24
      run: |
        # Create directory
        ssh -i ~/.ssh/id_ed25519 $USER@$HOST "mkdir -p $PROJECT_PATH"

        # Transfer files
        rsync -avz -e "ssh -i ~/.ssh/id_ed25519" \
          --exclude '.git' --exclude 'venv' --exclude 'node_modules' --exclude '__pycache__' \
          ./ $USER@$HOST:$PROJECT_PATH/

        # Deploy
        ssh -i ~/.ssh/id_ed25519 $USER@$HOST "cd $PROJECT_PATH && \
          export DOMAIN=${{ env.DOMAIN }} && \
          export ENV_NAME=${{ env.ENV_NAME }} && \
          export GEMINI_API_KEY='AIzaSyC5GHxQHeJaFZsiNJmOjBos3-QJlu9fDKc' && \
          if [ ! -f .env ]; then cp .env.example .env 2>/dev/null || touch .env; fi && \
          docker network create assistant-net 2>/dev/null || true && \
          docker compose down --remove-orphans && \
          docker compose up -d --build"

    - name: Complete job
      run: echo "âœ… Deploy to ${{ env.DOMAIN }} finished"
